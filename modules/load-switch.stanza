#use-added-syntax(jitx)
defpackage ocdb/modules/load-switch :
  import core
  import collections
  import math
  import jitx
  import jitx/commands
  import ocdb/utils/defaults
  import ocdb/utils/generic-components
  import ocdb/utils/generator-utils
  import ocdb/utils/checks
  import ocdb/utils/design-vars

  import ocdb/utils/property-structs

; Generated by GPT4 (then corrected). RDS ON ~= 5ohms @600ma
; Normally off design for minimal leakage.
public pcb-module discrete-mosfet () :
  pin control
  pin power
  pin gnd
  pin load

  ; Declare the components
  inst P : database-part(["mpn" => "BSN20", "manufacturer" => "Shikues"])
  property(P.vth) = min-max(0.5, 1.5)
  inst N : database-part(["mpn" => "BSS138", "manufacturer" => "Changjiang Electronics Tech (CJ)"])
  ; Gate voltage as function of drain current
  property(N.VGID) = PWL([[0.0 0.0] [1.0e-6 1.0] [0.08 2.0] [0.4 3.0] [1.0 4.0]])
  val resistance = 1.0e6
  inst R : chip-resistor(resistance)

  ; Connect the P-channel MOSFET
  net (P.D load)
  net (P.S power)

  ; Connect the N-channel MOSFET
  net (N.D P.G)
  net (N.S gnd)
  net (N.G control)

  ; Connect the control pin to the P-channel MOSFET gate
  net (control P.G)

  ; Connect the pull-up resistor between the power pin and the P-channel MOSFET gate
  net (R.p[1] power)
  net (R.p[2] P.G)

  eval-when has-property?(P.S.net-voltage) :
    val vdd = property(P.S.net-voltage) 
    ; TODO Look at SPICE computations for this threshold voltage
    property(N.G.digital-input) = DigitalInput(typ(0.5), vdd - property(P.vth), P.S, N.S, 10.0e-9)

  schematic-group(self) = load-sw
  layout-group(self) = load-sw
